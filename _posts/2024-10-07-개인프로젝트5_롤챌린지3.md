---
title: "ê°œì¸í”„ë¡œì íŠ¸5_ë¡¤ì±Œë¦°ì§€ì†Œê°œí˜ì´ì§€3"
excerpt: "í”„ë¡œì íŠ¸ì§„í–‰"

categories:
  - Categories7

tags:
  - [tag1, tag2]

permalink: /categories7/personalproject5-3/

toc: true
toc_sticky: true

date: 2024-10-08
last_modified_at: 2024-10-08
---

# ë¡¤ì±Œë¦°ì§€ì†Œê°œí˜ì´ì§€

# React suspense / Loading /streaming SSR/ Custom Errorì„¤ì • & global-error

## ğŸŒŸ React suspenseë¥¼ ì‚¬ìš©í•œ ë¡œë”© ìƒíƒœê´€ë¦¬

### React suspenseë€?

: ë¹„ë™ê¸°ì ìœ¼ë¡œ ë°ì´í„°ë¥¼ ë¡œë“œí•  ë•Œ ë¯¸ë¦¬ ì •í•´ì§„ ì»´í¬ë„ŒíŠ¸ë¥¼ ë Œë”ë§, ë¡œë“œ ì™„ë£Œì‹œì— ì‹¤ì œ ë°ì´í„°ë¥¼ ë Œë”ë§

### React suspense ì‚¬ìš©ì´ìœ 

- ìƒíƒœë¥¼ í•œ ê³³ì—ì„œ ê´€ë¦¬í•  ìˆ˜ ìˆê³  ì„ ì–¸ì ìœ¼ë¡œ ì‚¬ìš©ê°€ëŠ¥í•˜ë‹¤.
- ë¡œë”©ì‹œê°„ì´ ê¸¸ì–´ì§ˆ ë•Œ ì‚¬ìš©ìê°€ í° í™”ë©´ë§Œ ë³´ëŠ” ê²ƒì´ ì•„ë‹Œ ìŠ¤ì¼ˆë ˆí†¤ UIë‚˜ ìŠ¤í”¼ë„ˆ ê°™ì€ ë¡œë”© í‘œì‹œë¥¼ ë‚˜íƒ€ë‚´ì¤Œìœ¼ë¡œì¨ ì‚¬ìš©ìì—ê²Œ ì•±ì´ ì‘ë‹µí•˜ê³  ìˆìŒì„ í‘œì‹œí•˜ë©° ë” ë‚˜ì€ UXë¥¼ ì œê³µí•˜ê¸° ìœ„í•´ì„œì´ë‹¤.

#### - React suspenseë¥¼ ë¯¸ì‚¬ìš© & ê¸°ì¡´ useEffect()ì‚¬ìš© ë Œë”ë§ ë°©ë²•

: try catchë¬¸ìœ¼ë¡œ ì—ëŸ¬&ë¡œë”© ë°œìƒì‹œ ì²˜ë¦¬ë¥¼ í•´ì¤Œ

```tsx
// ì±”í”¼ì–¸ ìƒì„¸ ì •ë³´
export async function fetchChampionDetail(
  id: string
): Promise<ChampionDetail | null> {
  const version = await fetchVersion();
  try {
    const res = await fetch(
      `${BASEURL}/cdn/${version}/data/ko_KR/champion/${id}.json`
    );
    const data = await res.json();

    return data.data[id];
  } catch (error) {
    console.log(error, "championDetail Error");
    return null;
  }
}
```

---

## React suspenseì‚¬ìš©í•´ë³´ê¸°

### ì „ì²´í˜ì´ì§€ì— ì„¤ì •í•˜ëŠ” ë°©ë²•

1. page.tsxì™€ ê°™ì€ ìœ„ì¹˜ì— loading.tsxìƒì„±
   ![](https://velog.velcdn.com/images/alice0751/post/0758ab5b-988a-443c-8591-a087c582353b/image.png)
2. loading.tsxì— ë¡œë”©ì‹œ ë‚˜íƒ€ë‚¼ UIì‘ì„±

```tsx
export default function Loading() {
  return <div>Loading...</div>;
}
```

3. layout.tsx (ì‚¬ìš©í•  ìœ„ì¹˜ì˜ ë¶€ëª¨ ì»´í¬ë„ŒíŠ¸ì—ì„œ)
   Suspense fallback ì ìš©

```tsx
export default function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode;
}>) {
  return (
    <html lang="en">
      <body
        className={`${geistSans.variable} ${geistMono.variable} antialiased`}
      >
        <Header />
        <Suspense fallback={<Loading />}>{children}</Suspense>
        <Footer />
      </body>
    </html>
  );
}
```

---

## â˜˜ï¸ Server-side Rendering / Streaming HTML

### Streaming HTML

: ëª¨ë“  ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ê¸° ì „ HTMLì„ ìŠ¤íŠ¸ë¦¬ë°

#### SSRì˜ flow

1. Server(API)ë¡œ ë¶€í„° Dataë¥¼ ê°€ì ¸ì˜´

2. Server(Next.js)ì—ì„œ HTMLì„ ë Œë”ë§ í•¨

3. Client(browser)ì—ì„œ ì½”ë“œ(HTML)ë¥¼ ë°›ìŒ

4. JavaScriptë¥¼ ë°›ì•„ì™€ Hydratingí•¨

### ê°œë³„í˜ì´ì§€ì— ì„¤ì •í•˜ëŠ” ë°©ë²•

1. streaming SSRë¥¼ ì‚¬ìš©í•˜ë ¤ê³  í•˜ëŠ” í˜ì´ì§€ì—ì„œ ì •ë³´ë¥¼ fetchingí•˜ëŠ” ë¶€ë¶„ì— ê°œë³„ Suspenseì²˜ë¦¬

// item.tsx

```tsx
"use server";
import ItemCard from "@/components/ItemCard";
import { Item } from "@/types/Item";
import { fetchItem } from "@/utils/serverApi";
import React, { Suspense } from "react";
import Loading from "../loading";

const ItemPage = async () => {
  const items: Item[] = await fetchItem();
  return (
    <div>
      <h1 className="text-center mt-12 text-3xl font-extrabold">ì•„ì´í…œ ëª©ë¡</h1>
      <div className="w-[80%] grid grid-cols-4 sm:grid-cols-6 lg:grid-cols-8 mx-auto mt-12 gap-4">
        <Suspense fallback={<Loading />}>
          {items?.map((item) => (
            <ItemCard key={item.id} item={item} />
          ))}
        </Suspense>
      </div>
    </div>
  );
};

export default ItemPage;
```

2. ê°œë³„ loading UIì„¤ì •

- loading.tsì—ì„œ typeì„ propsë¡œ ë°›ì•„ì„œ switchë¬¸ ì‘ì„±
- typeì„¤ì •

// loading.tsx

```tsx
type LoadingProps = {
  type: string;
};

const Loading: React.FC<LoadingProps> = ({ type }) => {
  switch (type) {
    case "page1":
      return <div>ì±”í”¼ì–¸ ë¦¬ìŠ¤íŠ¸ ë¡œë”©ì¤‘ì…ë‹ˆë‹¤..</div>;
    case "page2":
      return <div>ì±”í”¼ì–¸ ìƒì„¸í˜ì´ì§€ ë¡œë”©ì¤‘ì…ë‹ˆë‹¤...</div>;
    case "page3":
      return <div>ì•„ì´í…œ ë¦¬ìŠ¤íŠ¸ ë¡œë”©ì¤‘ì…ë‹ˆë‹¤...</div>;
    default:
      return <div>ë¡œë”©ì¤‘ì…ë‹ˆë‹¤...</div>;
  }
};

export default Loading;
```

- item.tsxíŒŒì¼ì—ì„œ Loading ë¶€ë¶„ type propsë¡œ ë‚´ë ¤ì£¼ê¸°
  // item.tsx

```tsx
"use server";
import ItemCard from "@/components/ItemCard";
import { Item } from "@/types/Item";
import { fetchItem } from "@/utils/serverApi";
import React, { Suspense } from "react";
import Loading from "../loading";

const ItemPage = async () => {
  const items: Item[] = await fetchItem();
  return (
    <div>
      <h1 className="text-center mt-12 text-3xl font-extrabold">ì•„ì´í…œ ëª©ë¡</h1>
      <div className="w-[80%] grid grid-cols-4 sm:grid-cols-6 lg:grid-cols-8 mx-auto mt-12 gap-4">
        <Suspense fallback={<Loading type={"page3"} />}>
          {items?.map((item) => (
            <ItemCard key={item.id} item={item} />
          ))}
        </Suspense>
      </div>
    </div>
  );
};

export default ItemPage;
```

---

## â˜˜ï¸ Custom Errorì„¤ì • & global-error ì„¤ì •

1. src > app > error.tsx ìƒì„±
2. useRouterì™€ startTransitionì„ ì‚¬ìš©í•´ ì¬ì‹œë„ ë²„íŠ¼ ìƒì„±

// ErrorComponent

```tsx
"use client";

import { CustomError } from "@/types/Error";
import { useRouter } from "next/router";
import { startTransition } from "react";

interface errorProps {
  error: CustomError;
}
const ErrorComponent = ({ error }: errorProps) => {
  const router = useRouter();

  const handleRetry = () => {
    startTransition(() => {
      router.replace(router.asPath); // í˜ì´ì§€ ì¬ì‹œë„
    });
  };
  return (
    <div>
      <h2>Errorê°€ ë°œìƒí•˜ì˜€ìŠµë‹ˆë‹¤.</h2>
      <p>{error.message}</p>
      <button onClick={handleRetry}>ì¬ì‹œë„</button>
    </div>
  );
};

export default ErrorComponent;
```

3. src > app > global-error.tsx ìƒì„±
4. useRouterì™€ startTransitionì„ ì‚¬ìš©í•´ í™ˆìœ¼ë¡œ ëŒì•„ê°ˆ ìˆ˜ ìˆê²Œ ì„¤ì •
   // global-error.tsx

```tsx
"use client";

import { useRouter } from "next/router";
import { startTransition } from "react";

interface globalErrorProps {
  error: string;
}
const GlobalError = ({ error }: globalErrorProps) => {
  const router = useRouter();
  const handleReset = () => {
    startTransition(() => {
      router.push("/"); // í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸°
    });
  };

  return (
    <div>
      <h2>ì—ëŸ¬ê°€ ë°œìƒí•˜ì˜€ìŠµë‹ˆë‹¤.</h2>
      <p>{error}</p>
      <button onClick={handleReset}>Go to Home</button>
    </div>
  );
};

export default GlobalError;
```

5. typeì„¤ì •í•˜ê¸°
   src>types>error.ts

```tsx
export interface CustomError {
  message: string;
}
```

# ğŸ’¥ Trouble Shooting

6. Custom Errorë©”ì„¸ì§€ë¥¼ í‘œì‹œí•  ì»´í¬ë„ŒíŠ¸ì— ì ìš©ì‹œì¼œì£¼ê¸°

#### ğŸ¥µ ë¬¸ì œì 

: apië¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” src>utils>serverApi.tsì—ì„œ errorë©”ì„¸ì§€ë¥¼ ì„¤ì •í•´ì¤€ í›„ src>app>champions>page.tsx apië¥¼ ê°€ì ¸ì™€ ë ˆì´ì•„ì›ƒì„ ê·¸ë¦¬ëŠ” í˜ì´ì§€ë“¤ì´ typeì˜¤ë¥˜ê°€ ë°œìƒí–ˆë‹¤.

// serverApi.ts

```tsx
// ìµœì‹ ë²„ì „
export async function fetchVersion(): Promise<string | CustomError> {
  try {
    const fetchVersion = await fetch(`${BASEURL}/api/versions.json`);
    const versionRes = await fetchVersion.json();
    return versionRes[0]; // ìµœì‹  ë²„ì „ ë°˜í™˜
  } catch (error) {
    console.log(error, "Version Error");
    return {
      message: "ìµœì‹  ë²„ì „ì„ ê°€ì ¸ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.",
    };
  }
}
```

ì˜¤ë¥˜í™”ë©´
![](https://velog.velcdn.com/images/alice0751/post/4c880e5c-a90e-4b3c-ba81-2ae9ce0e3829/image.png)

- ë‚´ê°€ ì˜ˆìƒí•œ ì˜¤ë¥˜ëŠ” ì´ë¯¸ ì•„ë˜ì²˜ëŸ¼ dataì— typeì´ ì„¤ì •ë˜ì–´ìˆëŠ”ë° ì—¬ê¸°ì„œ ì„¤ì •í•œ typeì•ˆì— errorì²˜ë¦¬ëŠ” ì—†ì–´ì„œì˜€ë‹¤.

```tsx

export default async function ChampionPage() {
  const data: ChampionListResponse = await fetchChampionList();

  return (
    <>
      <h1 className="font-extrabold text-3xl text-center mt-12">ì±”í”¼ì–¸ëª©ë¡</h1>
```

- 1ì°¨ í•´ê²°ë°©ë²•
  ë‚´ê°€ ìƒê°í–ˆë˜ ì´ìœ ê°€ ë§ì•˜ê³  dataì˜ typeì§€ì • ë¶€ë¶„ì— CustomErrorë„ í•¨ê»˜ ì¶”ê°€ì‹œì¼œì£¼ë‹ˆ championListí˜ì´ì§€ëŠ” ì—ëŸ¬ê°€ í•´ê²°ë˜ì—ˆë‹¤!

```tsx

export default async function ChampionPage() {
  const data: ChampionListResponse | CustomError = await fetchChampionList();

  return (
    <>
      <h1 className="font-extrabold text-3xl text-center mt-12">ì±”í”¼ì–¸ëª©ë¡</h1>
      <div className="w-[80%] grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 mx-auto mt-12 gap-4">
        <Suspense fallback={<Loading type="page1" />}>
          {Object.values(data).map((champion) => (
            <ChampionCard key={champion.id} champion={champion} />
          ))}
        </Suspense>
      </div>
    </>
  );
```

#### ğŸ¥µ ë˜ ë‹¤ë¥¸ ì—ëŸ¬ ë°œìƒ

- ë‹¤ë¥¸ í˜ì´ì§€ë“¤ë„ ê°™ì€ ë°©ì‹ìœ¼ë¡œ í•´ê²°í•˜ë©´ ë  ê²ƒ ê°™ë‹¤ê³  ìƒê°í–ˆëŠ”ë° ì ìš©ì‹œì¼œë³´ë‹ˆ ë˜ ë‹¤ë¥¸ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆë‹¤.
  ![](https://velog.velcdn.com/images/alice0751/post/ff22002b-72f6-478d-b378-6b257e1d2fa7/image.png)

#### âœ¨ í•´ê²°ë°©ë²•

- fetchì—ì„œ ë„˜ì–´ì˜¨ dataë¥¼ itemsë¡œ ì €ì¥ì„ í–ˆì—ˆë‹¤. fetchê°€ ì‹¤íŒ¨í•´ì„œ ë°ì´í„°ê°€ ë„˜ì–´ì˜¬ê²½ìš° messageê°€ ë„˜ì–´ì˜¤ëŠ”ë° ì´ê²ƒì´ ë‚´ê°€ ì§€ì •í•´ì¤€ Item[]ì— ì—†ì–´ì„œ ì˜¤ë¥˜ê°€ ë°œìƒ
- í•´ê²°í•˜ê¸° ìœ„í•´ì„œ dataì•ˆì— messageê°€ ìˆëŠ”ì§€ í™•ì¸í•˜ëŠ” ë¡œì§ì„ ì¶”ê°€í•´ì£¼ì—ˆë‹¤ í•´ê²°!

```tsx
const ItemPage = async () => {
  const items: Item[] | CustomError = await fetchItem();

  if ("message" in items) {
    return <ErrorComponent error={items} />;
  }
  return (
    <div>
      <h1 className="text-center mt-12 text-3xl font-extrabold">ì•„ì´í…œ ëª©ë¡</h1>
      <div className="w-[80%] grid grid-cols-4 sm:grid-cols-6 lg:grid-cols-8 mx-auto mt-12 gap-4">
        <Suspense fallback={<Loading type={"page3"} />}>
          {items?.map((item) => (
            <ItemCard key={item.id} item={item} />
          ))}
        </Suspense>
      </div>
    </div>
  );
};
```

---

# ğŸ’¥ Trouble Shooting 2 & ì½”ë“œ ë¦¬í™í† ë§

#### ğŸ¥µ ë¬¸ì œì 

- rotationí˜ì´ì§€ëŠ” client side rendering ë°©ì‹ìœ¼ë¡œ ë Œë”ë§ì„ í•˜ê³  ìˆì—ˆê³  useEffect()ë¥¼ í†µí•´ í˜ì´ì§€ê°€ ì²˜ìŒ ë¡œë“œë  ë•Œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ìˆë„ë¡ ì²˜ë¦¬ë¥¼ í–ˆì—ˆë‹¤. ì´ ê³¼ì •ì—ì„œ useState()ë¥¼ ì‚¬ìš©í•˜ì—¬ loadingê³¼ Errorë¥¼ ë”°ë¡œ ì²˜ë¦¬í•´ì£¼ì—ˆëŠ”ë° useQueryë¥¼ ì‚¬ìš©í•˜ë©´ ê°€ë…ì„±ë¶€ë¶„ê³¼ ê´€ë¦¬ì¸¡ë©´ì—ì„œë„ ë” ìš©ì´í•  ê²ƒ ê°™ì•„ ë¦¬í™í† ë§ í•˜ê²Œ ë˜ì—ˆë‹¤.

#### ìˆœì„œ

1. Tanstack Queryì„¤ì¹˜

```tsx
yarn add @tanstack/react-query

```

2. app>providers.tsxìƒì„± í›„ ë¡œì§ì‘ì„±

```tsx
"use client";

import {
  isServer,
  QueryClient,
  QueryClientProvider,
} from "@tanstack/react-query";

function makeQueryClient() {
  return new QueryClient({
    defaultOptions: {
      queries: {
        staleTime: 60 * 1000,
      },
    },
  });
}

let browserQueryClient: QueryClient | undefined = undefined;

function getQueryClient() {
  if (isServer) {
    return makeQueryClient();
  } else {
    if (!browserQueryClient) browserQueryClient = makeQueryClient();
    return browserQueryClient;
  }
}

export default function Providers({ children }: { children: React.ReactNode }) {
  const queryClient = getQueryClient();

  return (
    <QueryClientProvider client={queryClient}>{children}</QueryClientProvider>
  );
}
```

3. CSRì—ì„œ useQueryì‚¬ìš©

- useQueryë¥¼ ì‚¬ìš©í•´ data, isLoading, error ì²˜ë¦¬

```tsx
"use client";

import ChampionCard from "@/components/ChampionCard";
import { Champion, ChampionListResponse } from "@/types/Champion";
import { getChampionRotation } from "@/utils/riotApi";
import { fetchChampionList } from "@/utils/serverApi";
import React from "react";
import { useQuery } from "@tanstack/react-query";
import { CustomError } from "@/types/Error";
import ErrorComponent from "../error";

const fetchRotationData = async (): Promise<Champion[]> => {
  // ì´ë²ˆ ì£¼ ë¡œí…Œì´ì…˜ ë°ì´í„°
  const res = await getChampionRotation();
  const rotationIds = res.freeChampionIds || [];

  // ì „ì²´ ë°ì´í„°
  const championListRes: ChampionListResponse | CustomError =
    await fetchChampionList();

  // CustomError ì²˜ë¦¬
  if ("message" in championListRes) {
    throw new Error("championListì—ëŸ¬ì…ë‹ˆë‹¤");
  }

  // ë¡œí…Œì´ì…˜ idì™€ ì „ì²´ ë°ì´í„°ì˜ key ë¹„êµí•˜ì—¬ ë§¤ì¹­ë˜ëŠ” ë°ì´í„° ì¶”ì¶œ
  return Object.keys(championListRes)
    .filter((championKey) =>
      rotationIds.includes(parseInt(championListRes[championKey].key))
    )
    .map((key) => championListRes[key]);
};

const RotationPage = () => {
  const {
    data: rotationData,
    isLoading,
    error,
  } = useQuery<Champion[], Error>({
    queryKey: ["champitonRotation"],
    queryFn: fetchRotationData,
  });

  if (isLoading) {
    return <div>Loading...</div>;
  }

  if (error) {
    return <ErrorComponent error={error} />;
  }

  return (
    <div>
      <h1 className="font-extrabold text-3xl text-center mt-12 text-red-400">
        ì´ë²ˆì£¼ ë¡œí…Œì´ì…˜ ì±”í”¼ì–¸
      </h1>
      <div className="w-[80%] grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 mx-auto mt-12 gap-4">
        {rotationData?.map((champion) => (
          <ChampionCard key={champion.key} champion={champion} />
        ))}
      </div>
    </div>
  );
};

export default RotationPage;
```

---
