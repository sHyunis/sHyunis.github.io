---
title: "Next.js&SUPABASE"
excerpt: "SETUP"

categories:
  - Categories9
tags:
  - [tag1, tag2]

permalink: /categories9/Next.js supabase/

toc: true
toc_sticky: true

date: 2024-09-29
last_modified_at: 2024-09-29
---

# Supabase set up

1. terminalì— ìž…ë ¥

```js
yarn add @supabase/ssr @supabase/supabase-js
```

2. .env.local sup abase ì—°ê²° URL, KEY ì„¤ì •

```js
NEXT_PUBLIC_SUPABASE_URL = example;
NEXT_PUBLIC_SUPABASE_ANON_KEY = example;
```

3. src>utils>supabase>
   client.ts
   middleware.ts
   server.ts ìƒì„±
   ![](https://velog.velcdn.com/images/alice0751/post/3ffbc7d3-ae38-47f3-8bc1-887d5a675350/image.png)

4. ì‚¬ìš©í•˜ëŠ” ê³³ê³¼ ì—°ê²°

```ts
const HomePage = async () => {
  const { data } = await getNewProducts();
  const serverClient = createClient();
  const { data: supabaseData } = await serverClient.from("products").select();

```

5. supbase tableì—ì„œ Add RLS policy
6. create policy í´ë¦­

7. src>app>auth/callback>route.ts

```js
import { NextResponse } from "next/server";
// The client you created from the Server-Side Auth instructions
import { createClient } from "@/utils/supabase/server";

export async function GET(request: Request) {
  const { searchParams, origin } = new URL(request.url);
  const code = searchParams.get("code");
  // if "next" is in param, use it as the redirect URL
  const next = searchParams.get("next") ?? "/";

  if (code) {
    const supabase = createClient();
    const { error } = await supabase.auth.exchangeCodeForSession(code);
    if (!error) {
      const forwardedHost = request.headers.get("x-forwarded-host"); // original origin before load balancer
      const isLocalEnv = process.env.NODE_ENV === "development";
      if (isLocalEnv) {
        // we can be sure that there is no load balancer in between, so no need to watch for X-Forwarded-Host
        return NextResponse.redirect(`${origin}${next}`);
      } else if (forwardedHost) {
        return NextResponse.redirect(`https://${forwardedHost}${next}`);
      } else {
        return NextResponse.redirect(`${origin}${next}`);
      }
    }
  }

  // return the user to an error page with instructions
  return NextResponse.redirect(`${origin}/auth/auth-code-error`);
}
```

---

## ðŸŒŸ Supabaseë¡œ ë°ì´í„°ë¥¼ ì¶”ê°€í•˜ëŠ” ë°©ë²•

1. supabase Authenticationì—ì„œ Create policy insert í´ë¦­ í›„ ì €ìž¥
2. ë¡œì§ìž‘ì„±

```js
"use client";
import browserClient from "@/utils/supabase/client";
import { Button } from "../ui/button";

export const AddProductbutton = () => {
  const onAddClick = async () => {
    const data = await browserClient.from("products").insert({
      is_new: true,
      price_amout: 10.0,
      title: "title",
      seo_title: "title",
      description: "description",
      seo_description: "description",
      rating: 1,
    });
  };
  return <Button onClick={onAddClick}>ì¶”ê°€</Button>;
};
```

## supabaseë°ì´í„° ìˆ˜ì •

1. supabase Table Editor ì—ì„œ Auth policies
2. Authenticationì—ì„œ Create policy

```js
create policy "policy_name"


on "public"."products"


as PERMISSIVE


for SELECT


to public


using (

// ì´ë¶€ë¶„ìˆ˜ì •
(select auth.uid()) = user_id
with check{
  (select auth.uid())=user_id
}

);
```

idë¶€ë¶„ì€ uuidë¡œ ì €ìž¥ë˜ì–´ì•¼í•¨

### supabase ë°ì´í„° ì‚­ì œ

1. supabase Authentication Policyì¶”ê°€ (delete)
2. ë¡œì§ì¶”ê°€

```js
"use client";
import browserClient from "@/utils/supabase/client";
import { Button } from "../ui/button";

export const AddProductbutton = () => {
  const onAddClick = async () => {
    // const data = await browserClient.from("products").insert({
    //   is_new: true,
    //   price_amout: 10.0,
    //   title: "title",
    //   seo_title: "title",
    //   description: "description",
    //   seo_description: "description",
    //   rating: 1,
    // });

    // await browserClient
    //   .from("products")
    //   .update({
    //     title: "updated Title",
    //   })
    //   .eq("id", 11);

    await browserClient.from("products").delete().eq("id", 12);
    return <Button onClick={onAddClick}>ì‚­ì œ</Button>;
  };
};
```

## supabase ì— storage image ì—…ë¡œë“œ í•˜ëŠ” ë°©ë²•

1. supabaseì—ì„œ Storageìƒì„±
2. ì´ë¦„ì„¤ì •
3. ë¡œì§ìž‘ì„±

```js
const serverClient = createClient();
const url = serverClient.storage
  .from("ì§€ì •í•œ ë²„í‚·ì´ë¦„")
  .getPublicUrl("logo.png");
```

---

# Next.jsë°°í¬

1.Github mainì— ìˆ˜ì •ì‚¬í•­ ë‹¤ í•©ì³ì£¼ê¸° 2. Vercel ì—ì„œ .env.local key value ë„£ì–´ì£¼ê³  ë°°í¬ 3. ì†Œì…œë¡œê·¸ì¸ ë“± ì‚¬ì´íŠ¸ ì£¼ì†Œ ë³€ê²½ì‹œì¼œì£¼ê¸°
4.Authentication > URL configuration Site URL ì— Vercel ë°°í¬ì£¼ì†Œ ë„£ì–´ì£¼ê¸° 5. Redirect URLì— localhost ì£¼ì†Œ ë„£ì–´ì£¼ê¸°

---

# ì„±ëŠ¥ ìµœì í™”

1. Next.js Analyzerì„¤ì¹˜

```js
yarn add @next/bundle-analyzer
```

2. next.config.mjs export ë³€ê²½

```js
/** @type {import('next').NextConfig} */
const nextConfig = {
  reactStrictMode: false,
  images: {
    remotePatterns: [
      {
        protocol: "https",
        hostname: "fakestoreapi.com",
        pathname: "/**",
      },
    ],
    formats: ["image/avif", "image/webp"],
  },
};

export default process.env.ANALYZE === "true"
  ? withBundleAnalyzer()(nextConfig)
  : nextConfig;
```

3. buildí•˜ê³  ë‚˜ë©´ ì–¼ë§ˆë‚˜ ë§Žì€ ìš©ëŸ‰ì„ ì°¨ì§€í•˜ê³  ìžˆëŠ” ì§€í™•ì¸ê°€ëŠ¥
4. ë„ˆë¬´ í° ëª¨ë“ˆì„ í™•ì¸í•˜ê³  ì§€ì—° ëª¨ë“ˆë¡œ ë³€ê²½ì‹œì¼œì¤Œ
5. lazy loading, dynamic()ì‚¬ìš©

```js
const Banner = dynamic(() => import("@/components/Banner"));

const HomePage = async () => {
  const { getNewProducts } = await import("@/services/server-action");
  const { data } = await getNewProducts();

```

6. Vercel Settingsì˜ Functionì— êµ­ê°€ë¥¼ í•œêµ­ìœ¼ë¡œ ë³€ê²½

---

## Next-auth

// ì•„ì§ ë² íƒ€ë²„ì „

1. ì„¤ì¹˜

```js
yarn add next-auth@beta
```

2. í™˜ê²½ ë³€ìˆ˜ì„¸íŒ…

```js
npx auth secret
```

3. app> auth.ts
   providerì„¸íŒ…

```js
import NextAuth, { User } from "next-auth";
import Credentials from "next-auth/providers/credentials";

export const { handlers, signIn, signOut, auth } = NextAuth({
  providers: [
    Credentials({
      name: "Credentials",
      credentials: {
        username: { label: "Username", type: "text", placeholder: "username" },
        password: { label: "Password", type: "password" },
      },
      async authorize(credentials): Promise<User | null> {
        const users = [
          {
            id: "test-user-1",
            userName: "test1",
            name: "Test 1",
            password: "pass",
            email: "test1@donotreply.com",
          },
          {
            id: "test-user-2",
            userName: "test2",
            name: "Test 2",
            password: "pass",
            email: "test2@donotreply.com",
          },
        ];
        const user = users.find(
          (user) =>
            user.userName === credentials.username &&
            user.password === credentials.password
        );
        return user
          ? { id: user.id, name: user.name, email: user.email }
          : null;
      },
    }),
  ],
  basePath: "/api/auth",
  secret: process.env.AUTH_SECRET,
});
```

3. src>app>api>auth>[...nextauth]
   route.ts

```js
import { handlers } from "@/auth";
export const { GET, POST } = handlers;
```
